<div class="col-4 text-center mb-4" style="padding-right:0 !important">
  <div class="product-card">
    <div class="row align-items-center" style="height: 250px;">

      <div id="rating-<%= prod.id %>" class="col-6">
        <span>Reviewlize Rating</span>
        <% if prod.result.present? %>
          <h3>3.6</h3>
          <div>
            <i class="fa fa-star" style="color:#2196F3"></i>
            <i class="fa fa-star" style="color:#2196F3"></i>
            <i class="fa fa-star" style="color:#2196F3"></i>
            <i class="fa fa-star-o" style="color:#2196F3"></i>
            <i class="fa fa-star-o" style="color:#2196F3"></i><br>
            <span style="font-size:10px">1560 Review</span>
          </div>
        <%else%>
          <div class="spinner my-4"></div>
        <%end%>
      </div>

      <div class="col-6 image-container">
        <img class="product-img" src='<%= prod.image_url%>' />
      </div>
      
    </div>

    <a href="<%=prod.url%>" style="color:black"><%= prod.name.truncate(70) %></a>

    <% if prod.result.present? %>
      <div class="d-flex justify-content-around last-analysis">
        <span style="font-size: 13px;font-weight: bold;">Last Update<br><%=prod.created_at.to_s.split(" ").first%></span>
        <button class="update-btn" id="prod-analyze-<%=prod.id%>">Update Now!</button>
      </div>

      <div id="prod-res-<%= prod.id %>" class="results-container">
        <%= render 'results', results: JSON.parse(prod.result) %>
      </div>
      <script>
        $("#prod-analyze-<%=prod.id%>").click(function(){
          $("#prod-analyze-<%=prod.id%>").parent().remove();
          $('#prod-res-<%= "#{prod.id}"%>').html("<div class=\"spinner\"></div>")
          $.get( '<%= "#{scrape_product_url}?product_url=#{prod.url}"%>', function(data) {
            var result = "";
            var all_pos = 0;
            var all_neg = 0;
            for (const item of Object.entries(data.results.aspect_analize)) {
              const name = item[0];
              const pos = item[1].positive;
              const neg = item[1].negative;
              all_pos += pos;
              all_neg += neg;
              result += `<div class="results-aspect-container"><span class="results-aspect">${name}</span><div class="progress bg-danger my-2"><div class="progress-bar bg-success" role="progressbar" style="font-weight: bold;width: ${pos == 0 && neg == 0 ? 50 : pos/(pos+neg)*100}%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">${(pos > 0 || (neg == 0 && pos == 0)) ? "+" : ""}</div></div></div>`
            }

            $('#prod-res-<%= "#{prod.id}"%>').html(result)
            var rating = "";
            var rate = all_pos/(all_pos+all_neg) * 5;
            rating += "<span>Reviewlize Rating</span>"
            rating += `<h3>${rate}</h3>`
            var i = 0;
            for(i; i < rate; i++){
              rating += "<i class=\"fa fa-star\" style=\"color:#2196F3\"></i>"
            }
            for(i; i < 5; i++){
              rating += "<i class=\"fa fa-star-o\" style=\"color:#2196F3\"></i>"
            }
            rating += "<br><span style=\"font-size:10px\">1560 Review</span>"
            $('#rating-<%= "#{prod.id}"%>').html(rating)
            
          });
        });
      </script>
    <% else %>
      <div id="prod-res-<%= prod.id %>" class="results-container">
        <div class="spinner"></div>
      </div>
      <script>
        $.get( '<%= "#{scrape_product_url}?product_url=#{prod.url}"%>', function(data) {
          var result = "";
          var all_pos = 0;
          var all_neg = 0;
          for (const item of Object.entries(data.results.aspect_analize)) {
            const name = item[0];
            const pos = item[1].positive;
            const neg = item[1].negative;
            all_pos += pos;
            all_neg += neg;
            result += `<div class="results-aspect-container"><span class="results-aspect">${name}</span><div class="progress bg-danger my-2"><div class="progress-bar bg-success" role="progressbar" style="font-weight: bold;width: ${pos == 0 && neg == 0 ? 50 : pos/(pos+neg)*100}%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">${(pos > 0 || (neg == 0 && pos == 0)) ? "+" : ""}</div></div></div>`
          }
          $('#prod-res-<%= "#{prod.id}"%>').html(result)
          var rating = "";
          var rate = all_pos/(all_pos+all_neg) * 5;
          rating += "<span>Reviewlize Rating</span>"
          rating += `<h3>${rate}</h3>`
          var i = 0;
          for(i; i < rate; i++){
            rating += "<i class=\"fa fa-star\" style=\"color:#2196F3\"></i>"
          }
          for(i; i < 5; i++){
            rating += "<i class=\"fa fa-star-o\" style=\"color:#2196F3\"></i>"
          }
          rating += "<br><span style=\"font-size:10px\">1560 Review</span>"
          $('#rating-<%= "#{prod.id}"%>').html(rating)
          

        });
      </script>
    <%end%>
    
  </div>
</div>


<script>
  
</script>